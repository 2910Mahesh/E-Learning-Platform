{% extends "base.html" %}
{% block title %}Quiz Result{% endblock %}

{% block content %}
<div class="text-center mt-5">
  <!-- Webcam Preview -->
  <video id="preview" width="320" height="240" autoplay muted class="mb-3 border border-secondary rounded"></video>

  {% if correct %}
    <h2 class="text-success"><i class="fas fa-check-circle"></i> Correct!</h2>
    <p>Great job! You've earned progress in your course.</p>
  {% else %}
    <h2 class="text-danger"><i class="fas fa-times-circle"></i> Oops! Wrong Answer</h2>
    <p>Try again later and keep learning!</p>
  {% endif %}

  <a href="{{ url_for('dashboard') }}" class="btn btn-primary mt-3" onclick="stopRecording()">Back to Dashboard</a>
</div>
{% endblock %}

{% block scripts %}
<script>
let mediaRecorder;
let recordedChunks = [];

navigator.mediaDevices.getUserMedia({ video: true, audio: true })
  .then(stream => {
    const preview = document.getElementById("preview");
    preview.srcObject = stream;
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = function (e) {
      if (e.data.size > 0) {
        recordedChunks.push(e.data);
      }
    };

    mediaRecorder.onstop = function () {
      const blob = new Blob(recordedChunks, { type: "video/webm" });
      const formData = new FormData();
      formData.append("video", blob);

      fetch("/upload_quiz_video", {
        method: "POST",
        body: formData,
      }).then(res => console.log("Recording uploaded."));
    };

    mediaRecorder.start();
  })
  .catch(error => {
    console.error("Webcam access denied or failed:", error);
  });

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
  }
}
</script>
{% endblock %}
